<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Cleciane Oliveira Silva">
  <link rel="stylesheet" href="../css/style.css">
  <title>Museum Cart</title>

  <style>
  
    main { 
      max-width: 720px; 
      margin: 0 auto; 
      padding: 16px; 
    }
    .controls { 
      margin: 8px 0 12px; 
    }
    .empty { 
      padding: 12px; 
      border: 1px dashed #666; 
      font-style: italic; 
    }

    
    pre#summary { 
      background: #f8f8f8; 
      padding: 12px; 
      font-family: Arial, sans-serif; 
    }
    .actions { margin-top: 12px; display: flex; gap: 8px; }

    button {
    padding: 10px 15px;
    margin-left: 10px;
    background-color: #2c3e50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    }
  </style>

</head>

<body>
  <header>
    <h1>Shopping Cart</h1>

    <div class="shopButtons">
      <button onclick="location.href='../index.html'">Home</button>
      <button onclick="location.href='staff.html'">Staff</button>
      <button onclick="location.href='collections.html'">Collections</button>
      <button onclick="location.href='shop.html'">Shop</button>
    </div>
  </header>

  <main>
    <!-- NEW CONTROLS (Cart page only) -->
    <div class="controls">
      <label><input type="checkbox" id="memberToggle"> Member Discount (15%)</label>
    </div>

    <!-- STATES & OUTPUT AREAS -->
    <div id="emptyMsg" class="empty" hidden>Your cart is empty.</div>
    <div id="items" hidden></div>
    <pre id="summary" hidden></pre>

    <!-- BASIC ACTIONS -->
    <div class="actions">
      <button id="clearBtn">Clear Cart</button>
      <a href="shop.html">Keep Shopping</a>
    </div>
  </main>

  <script>
  /* =================== PIPE FROM shop.html (leave as-is) =================== */
  // shop.html must write items with: data-id, data-name, data-price, data-image
  // addToCart(btn) should push objects { id, name, unitPrice, qty, image } to localStorage

  const CART_KEY = 'museumCartV1'; // MUST match shop.html

  function readCart(){
    try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; }
    catch { return []; }
  }
  function writeCart(cart){
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
  }
  /* ================= END PIPE ============================================= */


  /* ====================== UTILITIES & CONSTANTS =========================== */
  // Currency with parentheses for negatives
  function money(n){
    const sign = n < 0 ? -1 : 1;
    const s = '$' + Math.abs(n).toFixed(2);
    return sign < 0 ? '('+s+')' : s;
  }

  // Spec constants
  const TAX_RATE = 0.102;
  const MEMBER_DISCOUNT_RATE = 0.15;
  const SHIPPING_RATE = 25.00;
  const VOLUME_TIERS = [
    [0.00, 49.99, 0.00],
    [50.00, 99.99, 0.05],
    [100.00, 199.99, 0.10],
    [200.00, Infinity, 0.15]
  ];

  // Return the volume discount rate given an item total
  function volumeRate(total){
    for (const [min,max,rate] of VOLUME_TIERS){
      if (total >= min && total <= max) return rate;
    }
    return 0;
  }

  // Remove a line item entirely (qty=0 => drop row)
  function removeItem(id){
    const next = readCart().filter(it => it.id !== id);
    writeCart(next);
    render();
  }

  // Clear cart = initial state (cart empty, member unchecked)
  function clearCart(){
    writeCart([]);
    document.getElementById('memberToggle').checked = false;
    render();
  }
  /* ================== END UTILITIES & CONSTANTS =========================== */


  /* ====================== STUDENT WORK STARTS HERE =========================
     IMPLEMENT render() to mirror the commission assignment:*/

let discountChoice = null;

function render(){
  // DOM refs for this render
  const itemsDiv   = document.getElementById('items');
  const summaryPre = document.getElementById('summary');
  const emptyMsg   = document.getElementById('emptyMsg');
  const isMember   = document.getElementById('memberToggle').checked;

  // Load cart
  const cartRaw = readCart();
  const cart = cartRaw.filter(it => Number(it.qty) > 0 && Number(it.unitPrice) > 0 && Number.isFinite(Number(it.unitPrice)));
  const isEmpty = cart.length === 0;

  // Items list
  if (isEmpty) {
    itemsDiv.hidden = true;
    emptyMsg.hidden = false;
  } else {
    const rows = cart.map(it => {
      const lineTotal = it.unitPrice * it.qty;
      const leftText  = `${it.qty} Ã— ${it.name}`;
      const amtText   = money(lineTotal);
      return `
        <div class="cart-row" style="font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre; display: flex; gap: 8px; align-items: center;">
          <span style="flex:1 1 auto;">${leftText.padEnd(40,' ')}</span>
          <span style="min-width: 14ch; text-align: right;">${amtText}</span>
          <button onclick="removeItem('${it.id}')">Remove</button>
        </div>`;
    }).join('');
    itemsDiv.innerHTML = rows;
    itemsDiv.hidden = false;
    emptyMsg.hidden = true;
  }

  // Math
  let itemTotal = 0;
  for (const it of cart) itemTotal += it.unitPrice * it.qty;

  const volRate       = volumeRate(itemTotal);
  const volPotential  = itemTotal * volRate;
  const memPotential  = isMember ? itemTotal * MEMBER_DISCOUNT_RATE : 0;

  let appliedVolume = 0;
  let appliedMember = 0;

  if (volPotential > 0 && memPotential > 0) {
    if (discountChoice !== 'M' && discountChoice !== 'V') {
      const defaultChoice = memPotential >= volPotential ? 'M' : 'V';
      const ans = prompt(
        `Only one discount may be applied.\n` +
        `Type 'M' for Member (15%) or 'V' for Volume (${(volRate*100).toFixed(0)}%).`,
        defaultChoice
      );
      discountChoice = (ans && ans.trim().toUpperCase().startsWith('V')) ? 'V' : 'M';
    }
    appliedMember = (discountChoice === 'M') ? memPotential : 0;
    appliedVolume = (discountChoice === 'V') ? volPotential : 0;
  } else if (memPotential > 0) {
    discountChoice = 'M';
    appliedMember = memPotential;
  } else if (volPotential > 0) {
    discountChoice = 'V';
    appliedVolume = volPotential;
  } else {
    discountChoice = null;
  }

  const shipping     = isEmpty ? 0 : SHIPPING_RATE;
  const taxableSub   = itemTotal - appliedMember - appliedVolume + shipping;
  const taxAmount    = taxableSub * TAX_RATE;
  const invoiceTotal = taxableSub + taxAmount;

  //Summary
  const lines = [
    ['Subtotal of Items',  money(itemTotal)],
    ['Volume Discount',    money(-appliedVolume)],
    ['Member Discount',    money(-appliedMember)],
    ['Shipping',           money(shipping)],
    ['Subtotal (Taxable)', money(taxableSub)],
    ['Tax Rate %',         (TAX_RATE * 100).toFixed(1) + '%'],
    ['Tax Amount $',       money(taxAmount)],
    ['Invoice Total',      money(invoiceTotal)],
  ];

  const amtWidth   = Math.max(...lines.map(([_, amt]) => String(amt).length));
  const labelWidth = 24;

  const summaryText = lines
    .map(([label, amt]) => label.padEnd(labelWidth, ' ') + String(amt).padStart(amtWidth, ' '))
    .join('\n');

  summaryPre.textContent = summaryText;
  summaryPre.hidden = false;
}

document.getElementById('memberToggle').addEventListener('change', render);
document.getElementById('clearBtn').addEventListener('click', clearCart);

render();
</script>

</body>
</html>
